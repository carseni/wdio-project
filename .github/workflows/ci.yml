name: CI - Realworld Stack (Backend + UI + WDIO)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: realworld
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      # üß© WDIO project (current repo)
      - name: Checkout WDIO project
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # üß† Wait for Postgres
      - name: Wait for Postgres
        run: |
          echo "Waiting for Postgres to be ready..."
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 -U postgres; then
              echo "‚úÖ Postgres is ready!"
              break
            fi
            echo "‚è≥ Waiting ($i/30)..."
            sleep 2
          done

      # ‚öôÔ∏è Clone and prepare backend
      - name: Clone Backend
        run: |
          git clone https://github.com/carseni/realworld-backend.git realworld-backend
          cd realworld-backend
          npm ci
          npx prisma generate
          npx prisma migrate deploy
          npm run build
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/realworld

      # üßæ Verify DB migrations
      - name: Verify Database schema
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client
          echo "üìã Checking database tables..."
          PGPASSWORD=postgres psql -h localhost -U postgres -d realworld -c "\dt"
          echo "‚úÖ Database verification completed."
        env:
          PGPASSWORD: postgres

      - name: Start Backend (port 3000)
        run: |
          cd realworld-backend
          PORT=3000 npm start &
          echo "Waiting for API to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:3000/api/tags > /dev/null; then
              echo "‚úÖ API is up!"
              break
            fi
            echo "‚è≥ Waiting ($i/30)..."
            sleep 3
          done
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/realworld

      # üé® Clone and build frontend (port 4100 to avoid conflict)
      - name: Clone Frontend
        run: |
          git clone https://github.com/carseni/realworld-ui.git realworld-ui
          cd realworld-ui
          npm ci
          PORT=4100 npm run build

      # üß™ Run WDIO Tests
      - name: Run WDIO Tests (spec + BDD)
        run: |
          cd wdio-project-main || cd .
          npm ci
          npm run test:all
        env:
          CI: true
          API_URL: http://localhost:3000/api

      # üìä Upload Allure results
      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: reports/allure-results/
          if-no-files-found: warn

      # üß± Generate Allure HTML report
      - name: Generate Allure report
        if: always()
        run: |
          npx allure generate reports/allure-results --clean -o reports/allure-report || true
          if [ ! -f reports/allure-report/index.html ]; then
            mkdir -p reports/allure-report
            echo "<html><body><h1>Test Run Failed</h1><p>Check job logs for details.</p></body></html>" > reports/allure-report/index.html
          fi

      - name: Upload Allure HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: reports/allure-report/
          if-no-files-found: warn
